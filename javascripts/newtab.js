// Generated by CoffeeScript 1.8.0
(function() {
  var ChromePicturesNewTab;

  ChromePicturesNewTab = (function() {
    ChromePicturesNewTab.prototype.fetchSize = 500;

    ChromePicturesNewTab.prototype.attrRegexp = new RegExp("^[^-]+-photo-(.+)");

    function ChromePicturesNewTab($viewport) {
      this.$viewport = $viewport;
      this.$photo = $("#photo");
      this.$photoFooter = $("#photo-footer");
      this.$photoTitleLink = $("#photo-title-link");
      this.$photoTitleOwnerLink = $("#photo-title-owner-link");
      this.$photoRefreshLink = $("#photo-refresh-link");
      this.$photoPinLink = $("#photo-pin-link");
      this.$photoPinLinkText = $("#photo-pin-link span");
      this.viewportWidth = this.$viewport.width();
      this.viewportHeight = this.$viewport.height();
      window.addEventListener("resize", (function(_this) {
        return function() {
          _this.viewportWidth = _this.$viewport.width();
          return _this.viewportHeight = _this.$viewport.height();
        };
      })(this), false);
      this.ensureCachedPhoto("current").then((function(_this) {
        return function(photo) {
          var diffTime, nowTime, photoTime, timedOut;
          nowTime = (new Date()).getTime();
          photoTime = parseInt(photo.timestamp) || Infinity;
          diffTime = nowTime - photoTime;
          timedOut = diffTime > 900000;
          if (timedOut && !photo.isPinned) {
            return _this.advancePhoto();
          } else {
            _this.displayPhoto(photo);
            return _this.ensureCachedPhoto("next");
          }
        };
      })(this));
      this.bookmarksBar = new BookmarksBar();
      this.bookmarksBar.render(this.$viewport[0]);
      this.$photoRefreshLink.on("click", (function(_this) {
        return function() {
          return _this.withLoadingAnimation(_this.$photoRefreshLink, function() {
            return _this.refreshPhoto();
          });
        };
      })(this));
      this.$photoPinLink.on("click", (function(_this) {
        return function() {
          return _this.withLoadingAnimation(_this.$photoPinLink, function() {
            return _this.togglePinned();
          });
        };
      })(this));
      document.body.addEventListener("click", (function(_this) {
        return function(event) {
          if (!$(event.target).closest(".bookmarks-popup").length) {
            return _this.bookmarksBar.hidePopupIfPresent();
          }
        };
      })(this), false);
      window.addEventListener("resize", (function(_this) {
        return function() {
          return _this.bookmarksBar.hidePopupIfPresent();
        };
      })(this), false);
    }

    ChromePicturesNewTab.prototype.withLoadingAnimation = function($target, func) {
      if (!$target.hasClass("loading")) {
        $target.addClass("loading");
        return func().then((function(_this) {
          return function() {
            return $target.removeClass("loading");
          };
        })(this));
      }
    };

    ChromePicturesNewTab.prototype.togglePinned = function() {
      return this.cachedPhoto("current").then((function(_this) {
        return function(photo) {
          photo.isPinned = !photo.isPinned;
          return chrome.storage.local.set({
            "current-photo-isPinned": photo.isPinned
          }, function() {
            return _this.updatePinnedDisplay(photo);
          });
        };
      })(this));
    };

    ChromePicturesNewTab.prototype.updatePinnedDisplay = function(photo) {
      return this.$photoPinLinkText.text(photo.isPinned ? "Unpin" : "Pin");
    };

    ChromePicturesNewTab.prototype.displayPhoto = function(photo) {
      console.log("Displaying photo", photo);
      chrome.storage.local.get(["current-photo-timestamp"], function(data) {
        var photoTime;
        console.log("Checking photo timestamp", data);
        if (!data["current-photo-timestamp"]) {
          photoTime = (new Date()).getTime();
          console.log("Setting photo timestamp to " + photoTime);
          data["current-photo-timestamp"] = photoTime;
          return chrome.storage.local.set(data);
        }
      });
      this.$photo.css("background-image", "url('" + photo.url + "')");
      this.$photoTitleLink.text(photo.title);
      this.$photoTitleLink.attr("href", photo.webUrl);
      this.$photoTitleOwnerLink.html("&copy; " + photo.ownerName);
      this.$photoTitleOwnerLink.attr("href", photo.ownerWebUrl);
      if ((photo.bottomGrayscale / 255.0) * 100 < 50) {
        this.$photoFooter.attr("data-color", "dark");
      } else {
        this.$photoFooter.attr("data-color", "light");
      }
      if ((photo.topGrayscale / 255.0) * 100 < 50) {
        $(this.bookmarksBar.$el).attr("data-color", "dark");
      } else {
        $(this.bookmarksBar.$el).attr("data-color", "light");
      }
      this.updatePinnedDisplay(photo);
      return null;
    };

    ChromePicturesNewTab.prototype.advancePhoto = function() {
      return this.ensureCachedPhoto("next").then((function(_this) {
        return function(photo) {
          photo.timestamp = null;
          return _this.savePhoto(photo, "current").then(function() {
            _this.displayPhoto(photo);
            return _this.deleteCachedPhoto("next").then(function() {
              return _this.ensureCachedPhoto("next");
            });
          });
        };
      })(this));
    };

    ChromePicturesNewTab.prototype.refreshPhoto = function() {
      return this.fetchPhoto().then((function(_this) {
        return function(photo) {
          return _this.savePhoto(photo, "next").then(function() {
            return _this.advancePhoto();
          });
        };
      })(this));
    };

    ChromePicturesNewTab.prototype.ensureCachedPhoto = function(prefix) {
      return this.cachedPhoto(prefix).then(null, (function(_this) {
        return function() {
          return _this.fetchPhoto().then(function(photo) {
            _this.savePhoto(photo, prefix);
            return photo;
          });
        };
      })(this));
    };

    ChromePicturesNewTab.prototype.cachedPhoto = function(prefix) {
      return new RSVP.Promise((function(_this) {
        return function(resolve, reject) {
          var err;
          try {
            return chrome.storage.local.get(["" + prefix + "-photo-dataUri", "" + prefix + "-photo-topGrayscale", "" + prefix + "-photo-bottomGrayscale", "" + prefix + "-photo-url", "" + prefix + "-photo-contentType", "" + prefix + "-photo-title", "" + prefix + "-photo-webUrl", "" + prefix + "-photo-ownerName", "" + prefix + "-photo-ownerWebUrl", "" + prefix + "-photo-timestamp", "" + prefix + "-photo-isPinned"], function(data) {
              var photo, _ref;
              photo = _this.decodePhoto(data);
              if (((_ref = photo.dataUri) != null ? _ref.length : void 0) > 0) {
                console.log("Photo cache hit: " + prefix);
                return resolve(photo);
              } else {
                console.warn("Photo cache miss: " + prefix);
                return reject();
              }
            });
          } catch (_error) {
            err = _error;
            console.error("Photo cache error: " + prefix, err);
            return reject(err);
          }
        };
      })(this));
    };

    ChromePicturesNewTab.prototype.savePhoto = function(photo, prefix) {
      return new RSVP.Promise((function(_this) {
        return function(resolve, reject) {
          var data, err;
          try {
            data = _this.encodePhoto(photo, prefix);
            return chrome.storage.local.set(data, function() {
              console.log("Photo saved with prefix: " + prefix);
              return resolve();
            });
          } catch (_error) {
            err = _error;
            console.error("Error saving photo", err);
            return reject(err);
          }
        };
      })(this));
    };

    ChromePicturesNewTab.prototype.deleteCachedPhoto = function(prefix) {
      return new RSVP.Promise((function(_this) {
        return function(resolve, reject) {
          var err;
          try {
            return chrome.storage.local.remove(["" + prefix + "-photo-dataUri", "" + prefix + "-photo-topGrayscale", "" + prefix + "-photo-bottomGrayscale", "" + prefix + "-photo-url", "" + prefix + "-photo-contentType", "" + prefix + "-photo-title", "" + prefix + "-photo-webUrl", "" + prefix + "-photo-ownerName", "" + prefix + "-photo-ownerWebUrl", "" + prefix + "-photo-timestamp", "" + prefix + "-photo-isPinned"], function() {
              console.log("Photo deleted with prefix: " + prefix);
              return resolve();
            });
          } catch (_error) {
            err = _error;
            console.error("Error deleting photo", err);
            return reject(err);
          }
        };
      })(this));
    };

    ChromePicturesNewTab.prototype.decodePhoto = function(data) {
      var photo;
      photo = {};
      _.each(_.keys(data), (function(_this) {
        return function(key) {
          var attrName;
          attrName = key.match(_this.attrRegexp)[1];
          return photo[attrName] = data[key];
        };
      })(this));
      return photo;
    };

    ChromePicturesNewTab.prototype.encodePhoto = function(photo, prefix) {
      var data;
      data = {};
      _.each(_.keys(photo), (function(_this) {
        return function(attr) {
          return data["" + prefix + "-photo-" + attr] = photo[attr];
        };
      })(this));
      return data;
    };

    ChromePicturesNewTab.prototype.fetchPhoto = function() {
      return new RSVP.Promise((function(_this) {
        return function(resolve, reject) {
          return _this.fetchPhotos().then(function(resp) {
            var index, ownerName, ownerWebUrl, photo, photos, title, webUrl;
            photos = $(resp).find("photo").toArray();
            index = parseInt(Math.random() * photos.length * 10, 10) % photos.length;
            photo = photos[index];
            title = photo.getAttribute("title");
            webUrl = _this.photoWebUrl(photo.getAttribute("owner"), photo.getAttribute("id"));
            ownerName = photo.getAttribute("ownername");
            ownerWebUrl = _this.ownerWebUrl(photo.getAttribute("owner"));
            console.log("Use photo at index " + index + " of " + photos.length + " photos", photo);
            console.log(" * title: " + title);
            console.log(" * webUrl: " + webUrl);
            console.log(" * ownerName: " + ownerName);
            return _this.fetchPhotoSizes(photo.getAttribute("id")).then(function(resp) {
              var contentType, largestSize, url;
              largestSize = _.reduce($(resp).find("size").toArray(), function(largest, size) {
                var largestArea, largestHeight, largestWidth, sizeArea, sizeHeight, sizeWidth;
                if (!largest) {
                  largest = size;
                }
                largestWidth = largest.getAttribute("width");
                largestHeight = largest.getAttribute("height");
                sizeWidth = size.getAttribute("width");
                sizeHeight = size.getAttribute("height");
                if (sizeWidth <= _this.viewportWidth || sizeHeight <= _this.viewportHeight) {
                  largestArea = largestWidth * largestHeight;
                  sizeArea = sizeWidth * sizeHeight;
                  if (sizeArea > largestArea) {
                    largest = size;
                  }
                }
                return largest;
              }, null);
              url = largestSize.getAttribute("source");
              contentType = "image/" + (url.match(/\.([^.]+)$/)[1]);
              photo.setAttribute("url", url);
              photo.setAttribute("content-type", contentType);
              return _this.urlToImageData(url, contentType).then(function(imageData) {
                return resolve({
                  dataUri: imageData.dataUri,
                  topGrayscale: imageData.topGrayscale,
                  bottomGrayscale: imageData.bottomGrayscale,
                  url: url,
                  contentType: contentType,
                  title: title,
                  webUrl: webUrl,
                  ownerName: ownerName,
                  ownerWebUrl: ownerWebUrl,
                  timestamp: null,
                  isPinned: false
                });
              });
            });
          })["catch"](function() {
            console.error("Error fetching photo", arguments);
            return reject.apply(null, arguments);
          });
        };
      })(this));
    };

    ChromePicturesNewTab.prototype.fetchPhotos = function() {
      return this.flickrApiRequest("flickr.interestingness.getList", {
        per_page: this.fetchSize,
        page: 1,
        extras: "license,owner_name"
      });
    };

    ChromePicturesNewTab.prototype.fetchPhotoSizes = function(id) {
      return this.flickrApiRequest("flickr.photos.getSizes", {
        photo_id: id
      });
    };

    ChromePicturesNewTab.prototype.flickrApiRequest = function(method, params) {
      return new RSVP.Promise(function(resolve, reject) {
        return $.ajax({
          type: "GET",
          url: "https://api.flickr.com/services/rest",
          data: _.extend({
            method: method,
            api_key: "7d05080a526b965ba4978c0656dfdaf3"
          }, params)
        }).done(function(resp, status, req) {
          return resolve(resp, status, req);
        }).fail(function(req, status, message) {
          return reject(req, status, message);
        });
      });
    };

    ChromePicturesNewTab.prototype.photoWebUrl = function(userId, photoId) {
      return "https://www.flickr.com/photos/" + userId + "/" + photoId;
    };

    ChromePicturesNewTab.prototype.ownerWebUrl = function(userId) {
      return "https://www.flickr.com/photos/" + userId;
    };

    ChromePicturesNewTab.prototype.urlToImageData = function(url, contentType) {
      return new RSVP.Promise((function(_this) {
        return function(resolve) {
          var canvas, ctx, img;
          canvas = document.createElement('CANVAS');
          ctx = canvas.getContext('2d');
          img = new Image();
          img.crossOrigin = 'Anonymous';
          img.onload = function() {
            var bottomData, topData;
            canvas.height = img.height;
            canvas.width = img.width;
            ctx.drawImage(img, 0, 0);
            topData = ctx.getImageData(0, 0, img.width, 20);
            bottomData = ctx.getImageData(0, img.height - 16, img.width, 16);
            resolve({
              dataUri: canvas.toDataURL(contentType),
              topGrayscale: _this.rgbToGrayscale(_this.averageRgb(topData)),
              bottomGrayscale: _this.rgbToGrayscale(_this.averageRgb(bottomData))
            });
            return $(canvas).remove();
          };
          return img.src = url;
        };
      })(this));
    };

    ChromePicturesNewTab.prototype.averageRgb = function(data) {
      var count, index, rgb;
      count = 0;
      index = 0;
      rgb = {
        r: 0,
        g: 0,
        b: 0
      };
      while (true) {
        if (index >= data.data.length) {
          break;
        }
        rgb.r += data.data[index];
        rgb.g += data.data[index + 1];
        rgb.b += data.data[index + 2];
        index += 5 * 4;
        count += 1;
      }
      rgb.r = Math.floor(rgb.r / count);
      rgb.g = Math.floor(rgb.g / count);
      rgb.b = Math.floor(rgb.b / count);
      return rgb;
    };

    ChromePicturesNewTab.prototype.rgbToGrayscale = function(rgb) {
      console.log(rgb);
      return (0.21 * rgb.r) + (0.72 * rgb.g) + (0.07 * rgb.b);
    };

    return ChromePicturesNewTab;

  })();

  window.onload = function() {
    var classicNewTab;
    return classicNewTab = new ChromePicturesNewTab($(document.body));
  };

}).call(this);
